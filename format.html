<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Invoice Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        display: flex;
        font-family: Arial, sans-serif;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #f0f0f0;
      }

      /* form design  */
      .form {
        width: 300px;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .form-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 12px;
      }
      .form input,
      .form button {
        width: 100%;
        margin-bottom: 10px;
        padding: 8px;
        font-size: 14px;
      }

      .field {
        margin-bottom: 14px;
      }

      .field label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 6px;
        color: #333;
      }

      .field input {
        width: 88%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }

      .field input:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
      }

      hr {
        border: none;
        border-top: 1px solid #eee;
        margin: 18px 0;
      }

      .btn {
        width: 80%;
        padding: 12px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 10px;
      }

      .btn.primary {
        background: #4f46e5;
        color: #fff;
        border: none;
      }

      .btn.primary:hover {
        background: #4338ca;
      }

      .btn.outline {
        background: #fff;
        border: 1px solid #ccc;
        color: #333;
      }

      .btn.outline:hover {
        background: #f9f9f9;
      }

      .container {
        display: flex;
        gap: 20px;
        /* align-items: flex-start; */
      }

      /* Delete list sits next to the form */
      .delete-list {
        width: 200px;
        padding: 20px;
        margin-top: 25.5%;
        margin-left: -80px; /* move slightly to the left */
        align-items: flex-start;
        color: white;
      }

      /* List styling */
      #itemsList {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      #itemsList li {
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #itemsList button {
        margin-left: 10px;
      }

      /* Style the select directly */
      #unit {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        background-color: #f9f9f9;
        transition: border-color 0.3s ease;
        margin-bottom: 15px;
      }

      /* Focus effect */
      #unit:focus {
        border-color: blue;
        outline: none;
        background-color: #fff;
      }

      @media print {
        @page {
          size: A4;
          margin: 0;
        }

        html,
        body {
          width: 210mm;
          height: 297mm;
          margin: 0;
          padding: 0;
        }

        body {
          background: white;
        }

        .form {
          display: none;
        }

        .invoice {
          margin: 0 auto;
          overflow: hidden;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- FORM -->
      <div class="form">
        <div class="field">
          <label>S.NO</label>
          <input
            type="text"
            id="serial"
            placeholder="Serial Number"
            maxlength="10"
            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
          />
        </div>

        <div class="field">
          <label>Customer Name</label>
          <input
            type="text"
            id="billToInput"
            placeholder="Enter customer name"
            maxlength="45"
          />
        </div>

        <div class="field">
          <label>Remarks</label>
          <input id="Remarks" placeholder="Remarks" maxlength="48" />
        </div>

        <div class="field">
          <label>Date</label>
          <input type="date" id="dateInput" />
        </div>

        <hr />
        <hr />

        <div class="field">
          <label>Particulars</label>
          <input id="name" placeholder="Particulars" />
        </div>

        <div class="field">
          <label>Unit</label>
          <select id="unit" onchange="toggleInputs()">
            <option value="km">Kilometers</option>
            <option value="trip">Toll/Driver</option>
          </select>
        </div>

        <div id="kmInputs">
          <div class="field">
            <label>Kilometers</label>
            <input id="qty" type="number" placeholder="Kilometers" />
          </div>
          <div class="field">
            <label>Fare/km</label>
            <input id="price" type="number" placeholder="Fare per km" />
          </div>
        </div>

        <div id="singleInput" style="display: none">
          <div class="field">
            <label>Amount</label>
            <input id="amount" type="number" placeholder="Enter amount" />
          </div>
        </div>

        <button class="btn primary" onclick="addItem()" id="addbtn">
          Add Item
        </button>
        <button class="btn outline" onclick="downloadPDF()">Save PDF</button>
        <button class="btn outline" onclick="printInvoice()">Print</button>
        <!-- <p id="limitMsg" style="color: red"></p> -->
      </div>

      <!-- INVOICE CANVAS -->
      <div class="invoice">
        <canvas id="invoiceCanvas" width="615" height="830"></canvas>
      </div>
      <div class="delete-list">
        <ul id="itemsList"></ul>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("invoiceCanvas");
      const ctx = canvas.getContext("2d");

      let items = []; // store all rows
      let grandTotal = 0;

      // Background image

      let invoiceBg = new Image();
      invoiceBg.src = "format.jpg"; // your invoice background image
      invoiceBg.onload = () => {
        drawHeader(); // only draw header after background is loaded
      };

      function drawHeader() {
        // clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // draw background image
        ctx.drawImage(invoiceBg, 0, 0, canvas.width, canvas.height);

        // overlay text

        ctx.font = "15px Arial";

        ctx.fillText(document.getElementById("serial").value, 68, 148);
        ctx.font = "13px Arial";
        const rawDate = document.getElementById("dateInput").value;
        if (rawDate) {
          const formattedDate = new Date(rawDate).toLocaleDateString("en-GB");
          ctx.fillText(formattedDate, 505, 180);
        }
        ctx.font = "15px Arial";
        ctx.fillText(
          document.getElementById("billToInput").value.toUpperCase(),
          78,
          200,
        );
        ctx.fillText(
          document.getElementById("Remarks").value.toUpperCase(),
          78,
          223,
        );

        // ctx.fillText(100, 380);

        // Draw items
        grandTotal = 0;
        items.forEach((item, index) => {
          ctx.textAlign = "left";
          const y = 310 + index * 30;
          ctx.textAlign = "right";
          ctx.fillText(index + 1, 62, y); // ✅ index always matches
          ctx.textAlign = "left";
          ctx.fillText(item.name, 100, y);
          if (item.unit === "km") {
            ctx.fillText(`${item.qty} km × Rs.${item.price}`, 320, y);
          } else {
            ctx.fillText(`Rs.${item.price}`, 320, y); // no ×1 for trip/toll/other
          }
          ctx.textAlign = "right";
          ctx.fillText(item.total, 520, y);
          grandTotal += item.total;
        });

        // Totals
        // ctx.clearRect(50, 900, 700, 50);
        ctx.font = "18px Arial";
        ctx.fillStyle = "red";
        if (grandTotal > 0) {
          ctx.fillText(grandTotal, 520, 664);
        }
        ctx.fillStyle = "black";
        ctx.font = "15px Arial";
        ctx.textAlign = "left"; // align text to the right edge
        if (grandTotal > 0) {
          ctx.fillText(
            (numberToWords(grandTotal) + " Only").toUpperCase(),
            130,
            701,
          );
        }
        // ctx.textAlign = "";
      }

      function toggleInputs() {
        const unit = document.getElementById("unit").value;
        const kmInputs = document.getElementById("kmInputs");
        const singleInput = document.getElementById("singleInput");

        if (unit === "km") {
          kmInputs.style.display = "block";
          singleInput.style.display = "none";
        } else {
          kmInputs.style.display = "none";
          singleInput.style.display = "block";
        }
      }

      function addItem() {
        if (items.length >= 10) {
          document.getElementById("addbtn").disabled = true;
          return;
        }

        const name = document.getElementById("name").value;
        const unit = document.getElementById("unit").value;

        let qty, price, total;

        if (unit === "km") {
          qty = Number(document.getElementById("qty").value);
          price = Number(document.getElementById("price").value);

          if (!name || qty <= 0 || price <= 0) {
            alert(
              "Please enter valid particulars, kilometers (>0), and fare/km (>0).",
            );
            return;
          }

          total = qty * price;
        } else {
          qty = 1; // always one unit for trip/toll/other
          price = Number(document.getElementById("amount").value);

          if (!name || price <= 0) {
            alert("Please enter valid particulars and amount (>0).");
            return;
          }

          total = price;
        }

        items.push({ name, qty, price, unit, total });

        updateItemsList();
        drawHeader();

        // Clear inputs
        // document.getElementById("name").value = "";
        // document.getElementById("qty").value = "";
        // document.getElementById("price").value = "";
        // document.getElementById("amount").value = "";
      }

      function updateItemsList() {
        const list = document.getElementById("itemsList");
        list.innerHTML = "";
        items.forEach((item, index) => {
          const li = document.createElement("li");
          // li.textContent = `${index + 1}. ${item.name} - ${item.qty} km × Rs.${item.price} = ${item.total}`;

          const btn = document.createElement("button");
          btn.textContent = "❌";
          btn.style.marginLeft = "10px";
          btn.onclick = () => deleteItem(index);

          li.appendChild(btn);
          list.appendChild(li);
        });
      }

      function deleteItem(index) {
        items.splice(index, 1); // remove item
        updateItemsList();
        drawHeader(); // redraw canvas with updated items

        if (items.length < 10) {
          document.getElementById("addbtn").disabled = false;
        }
      }

      function downloadPDF() {
        const { jsPDF } = window.jspdf; // destructure from window.jspdf
        const pdf = new jsPDF("p", "pt", "a4");
        const imgData = canvas.toDataURL("image/png");
        pdf.addImage(imgData, "PNG", 0, 0, 595, 842);
        pdf.save("invoice.pdf");
      }
      function printInvoice() {
        window.print();
      }
      // Initialize header on load
      window.onload = () => {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("dateInput").value = today;
        drawHeader();
      };

      // Redraw header when inputs change
      document.getElementById("serial").addEventListener("input", drawHeader);
      document
        .getElementById("billToInput")
        .addEventListener("input", drawHeader);
      document.getElementById("Remarks").addEventListener("input", drawHeader);
      document
        .getElementById("dateInput")
        .addEventListener("input", drawHeader);

      //amount in words

      function numberToWords(num) {
        if (num === 0) return "Zero";

        const a = [
          "",
          "One",
          "Two",
          "Three",
          "Four",
          "Five",
          "Six",
          "Seven",
          "Eight",
          "Nine",
          "Ten",
          "Eleven",
          "Twelve",
          "Thirteen",
          "Fourteen",
          "Fifteen",
          "Sixteen",
          "Seventeen",
          "Eighteen",
          "Nineteen",
        ];
        const b = [
          "",
          "",
          "Twenty",
          "Thirty",
          "Forty",
          "Fifty",
          "Sixty",
          "Seventy",
          "Eighty",
          "Ninety",
        ];

        function twoDigits(n) {
          return n < 20
            ? a[n]
            : b[Math.floor(n / 10)] + (n % 10 ? " " + a[n % 10] : "");
        }

        function threeDigits(n) {
          let str = "";
          if (n > 99) {
            str += a[Math.floor(n / 100)] + " Hundred ";
            n = n % 100;
          }
          if (n > 0) str += twoDigits(n);
          return str.trim();
        }

        let str = "";
        const crore = Math.floor(num / 10000000);
        const lakh = Math.floor((num % 10000000) / 100000);
        const thousand = Math.floor((num % 100000) / 1000);
        const hundred = num % 1000;

        if (crore) str += threeDigits(crore) + " Crore ";
        if (lakh) str += threeDigits(lakh) + " Lakh ";
        if (thousand) str += threeDigits(thousand) + " Thousand ";
        if (hundred) str += threeDigits(hundred);

        return str.trim();
      }
    </script>
  </body>
</html>
